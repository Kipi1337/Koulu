---
- name: Configure VLANs on Exos switches and VyOS router
  hosts: all
  gather_facts: no

  vars:
    vlans:
      - id: 100
        name: "KISULI"
        vyos_ip: "10.10.100.1/24"
        exos_ips:
          exos-switch1: "10.10.100.1"
          exos-switch2: "10.10.100.2"
          exos-switch3: "10.10.100.3"
          exos-switch4: "10.10.100.4"
        ports:
          exos-switch1: "1-4"
          exos-switch2: "1-4"
          exos-switch3: "1-2"
          exos-switch4: "1-2"

  tasks:
    - name: Ensure output directory exists
      file:
        path: backup/output
        state: directory
      tags: ensure

    - block:
        - name: Backup current VyOS configuration
          vyos.vyos.vyos_config:
            backup: true
            backup_options:
              dir_path: backup/output
              filename: "vyos2_{{ inventory_hostname }}_current.cfg"
          when: ansible_network_os == "vyos.vyos.vyos"

        - name: Backup current Exos configuration
          community.network.exos_config:
            backup: true
            backup_options:
              dir_path: backup/output
              filename: "exos2_{{ inventory_hostname }}_current.cfg"
          when: ansible_network_os == "community.network.exos"
      tags: backup

    - block:
        - name: Generate new VyOS configuration
          template:
            src: templates/vyos_vlan_template.j2
            dest: backup/output/vyos2_{{ inventory_hostname }}_new.conf
          loop: "{{ vlans }}"
          when: ansible_network_os == "vyos.vyos.vyos"

        - name: Generate new Exos configuration
          template:
            src: templates/exos_vlan_template.j2
            dest: backup/output/exos2_{{ inventory_hostname }}_new.conf
          loop: "{{ vlans }}"
          when: ansible_network_os == "community.network.exos"
      tags: generate

    - block:
        - name: Read generated Exos configuration file
          set_fact:
            exos_config: "{{ lookup('file', 'backup/output/exos2_' + inventory_hostname + '_new.conf') }}"
          when: ansible_network_os == "community.network.exos"

        - name: Extract IP addresses from Exos configuration
          set_fact:
            exos_ips: "{{ exos_config | regex_findall('configure vlan .*? ipaddress ([0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3})') }}"
          when: exos_config is defined

        - name: Print IPs or fail if none found
          block:
            - debug:
                var: exos_ips
            - name: Fail if no IP addresses are found
              fail:
                msg: "Error: No valid IP addresses found in the Exos configuration."
              when: exos_ips | length == 0
          when: exos_ips is defined
       
      tags: tests_exos

    - block:
        - name: Read generated VyOS configuration file
          set_fact:
            vyos_config: "{{ lookup('file', 'backup/output/vyos2_' + inventory_hostname + '_new.conf') }}"
          when: ansible_network_os == "vyos.vyos.vyos"

        - name: Hae IP-osoite address-sanan perässä
          set_fact:
            ip_address: "{{ vyos_config | regex_search('address\\s+(\\S+)$', '\\1', multiline=True) }}"
          when: vyos_config is defined

        - name: Tarkista, että IP-osoitteessa on oikea muoto
          assert:
            that:
              - ip_address.split('/') | first | regex_search('^(\d{1,3}\.){3}\d{1,3}$')
              - ip_address.split('/') | first | regex_search('^(\d{1,3}\.){3}\d{1,3}$') | length > 0
              - ip_address.split('/') | first | regex_search('^([0-9]{1,3}\.){3}[0-9]{1,3}$')
              - ip_address.split('/') | last | regex_search('^/[0-9]{1,2}$')
          register: ip_check

        - name: Tarkista jokaisen oktetin arvo
          assert:
            that:
              - ip_address.split('/') | first | regex_search('^(?!0)(\d{1,3}\.){3}(?!0)\d{1,3}$')  # Varmista, että ei ole nollaa ensimmäisessä oktetissa
              - (ip_address.split('/') | first).split('.') | map('int') | map('lessthan', 256) | list | length == 4
          register: octet_check       
      tags: tests
      
    - block:
          - name: Compare current VyOS configuration with new configuration
            command: "diff backup/output/vyos2_{{ inventory_hostname }}_current.cfg backup/output/vyos2_{{ inventory_hostname }}_new.conf"
            register: vyos_diff
            ignore_errors: yes
            when: ansible_network_os == "vyos.vyos.vyos"

          - name: List changes added in the new configuration for VyOS
            debug:
              msg: "Changes added in the new configuration:\n{{ vyos_diff.stdout_lines | select('search', '^>') | list }}"
            when: vyos_diff is defined and vyos_diff.stdout_lines is defined

          - name: Compare current Exos configuration with new configuration
            command: "diff backup/output/exos2_{{ inventory_hostname }}_current.cfg backup/output/exos2_{{ inventory_hostname }}_new.conf"
            register: exos_diff
            ignore_errors: yes
            when: ansible_network_os == "community.network.exos"

          - name: List changes added in the new configuration for Exos
            debug:
              msg: "Changes added in the new configuration:\n{{ exos_diff.stdout_lines | select('search', '^>') | list }}"
            when: exos_diff is defined and exos_diff.stdout_lines is defined
      tags: compare

    - block:
        - name: Apply new VyOS configuration
          vyos.vyos.vyos_config:
            src: backup/output/vyos2_{{ inventory_hostname }}_new.conf
          when: ansible_network_os == "vyos.vyos.vyos"

        - name: Apply new Exos configuration
          community.network.exos_config:
            src: backup/output/exos2_{{ inventory_hostname }}_new.conf
          when: ansible_network_os == "community.network.exos"
      tags: install
